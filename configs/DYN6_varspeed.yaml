---
# ============================================================================
# DYN6 — VARIABLE SPEED (non-constant): forces affect both heading AND speed
# ============================================================================
# speed_mode="variable_with_forces" — agent speed scales with net force.
# This is fundamentally different dynamics: agents slow in equilibrium,
# accelerate under imbalanced forces.
# Expect: richer spatial structure, harder to forecast
# ============================================================================

experiment_name: "DYN6_varspeed"

sim:
  N: 200
  T: 20.0
  dt: 0.04
  Lx: 25.0
  Ly: 25.0
  bc: "periodic"

test_sim:
  T: 50.0

model:
  type: "discrete"
  speed: 4.0
  speed_mode: "variable"   # KEY: forces affect speed (not just heading)

params:
  R: 4.0

noise:
  kind: "gaussian"
  eta: 0.2
  match_variance: true

forces:
  enabled: true
  type: "morse"
  params:
    Ca: 1.5
    Cr: 0.5
    la: 1.5
    lr: 0.5
    mu_t: 0.3
    rcut_factor: 5.0

alignment:
  enabled: true

density:
  nx: 64
  ny: 64
  bandwidth: 5.0

outputs:
  density_resolution: 64
  density_bandwidth: 5.0

train_ic:
  type: "mixed_comprehensive"
  gaussian:
    enabled: true
    n_runs: 80
    positions_x: [5.0, 10.0, 15.0, 20.0]
    positions_y: [5.0, 10.0, 15.0, 20.0]
    variances: [1.5, 3.0, 5.0]
    n_samples_per_config: 1
  uniform:
    enabled: true
    n_runs: 40
    n_samples: 40
  two_clusters:
    enabled: true
    n_runs: 24
    separations: [4.0, 7.0, 10.0]
    sigmas: [1.5, 3.0]
    n_samples_per_config: 4
  ring:
    enabled: false

test_ic:
  type: "mixed_test_comprehensive"
  gaussian:
    enabled: false
  uniform:
    enabled: true
    n_runs: 20
  two_clusters:
    enabled: false
  ring:
    enabled: false

rom:
  subsample: 3
  fixed_modes: 19
  density_transform: "raw"
  density_transform_eps: 1.0e-10
  shift_align: true
  shift_align_ref: "mean"
  mass_postprocess: "none"
  models:
    mvar:
      enabled: true
      lag: 5
      ridge_alpha: 1.0e-4
    lstm:
      enabled: true
      hidden_dim: 128
      n_layers: 2
      n_epochs: 200
      lr: 1.0e-3
      patience: 20

eval:
  metrics: ["r2", "rmse"]
  save_forecasts: true
  save_time_resolved: true
  forecast_start: 0.60
  clamp_mode: "C0"

# ================================================================
# WSINDy PDE Discovery -- 3-field system
# Variable speed: forces affect magnitude not just heading
# ================================================================
wsindy:
  enabled: true
  mode: "multifield"

  n_train: 30
  subsample: 3
  seed: 42

  # rho: div_p, lap_rho, div_rho_gradPhi, lap_rho2, lap_rho3  (5)
  # px:  px, p_sq_px, dx_rho, lap_px, rho_dx_Phi              (5)
  # py:  py, p_sq_py, dy_rho, lap_py, rho_dy_Phi              (5)
  multifield_library:
    morse: true
    rich: false

  model_selection:
    n_ell: 12
    p: [2, 2, 2]
    stride: [2, 2, 2]

  lambdas:
    log_min: -5
    log_max: 2
    n_points: 60

  bootstrap:
    enabled: true
    B: 50
    ci_alpha: 0.05

  forecast:
    clip_negative: true
    mass_conserve: true
    method: "auto"
