# ============================================================================
# ALVAREZ RATIOS CONFIGURATION - RATIO 0.10 TARGET
# ============================================================================
# Optimized for Alvarez band with strong regularization and full temporal sampling
#
# CONFIGURATION:
#   - Training: 400 runs × T=10s (reduced for faster iteration)
#   - ROM time step: Δt_ROM = 0.05s (NO subsampling, capture all dynamics)
#   - Spatial grid: 48×48 = 2304 dimensions
#   - POD dimension: d = 40 (moderate latent space)
#   - MVAR lag: w = 4 (very short lag with dense temporal data)
#   - T_ROM per run: 10/0.05 = 200 steps
#   - Windows per run: 200 - 4 = 196
#   - Total MVAR samples: 400 × 196 = 78,400
#   - MVAR params: 40² × 4 = 6,400
#   - Ratio params/data: 6,400/78,400 = 0.0816 ✓ (IN ALVAREZ BAND!)
#
# METHODOLOGY:
#   - Moderate latent dimension (d=40) for 48×48 grid
#   - Very short lag (w=4) with NO temporal subsampling
#   - Shorter trajectories (T=10s) for faster testing
#   - All timesteps captured (subsample=1)
#   - All sliding windows (dense sampling)
#   - Spectral stabilization (ρ_max = 0.98)
#   - STRONG regularization (ridge α = 0.5) to prevent overfitting
#   - Expected POD energy: ~60-70%
#   - Expected generalization: much better with strong regularization
# ============================================================================

# Model
model:
  type: discrete
  speed: 2.0
  speed_mode: constant_with_forces

# Simulation parameters
sim:
  N: 150
  Lx: 15.0
  Ly: 15.0
  bc: "periodic"
  T: 10.0                   # 10 seconds → 200 ROM steps
  dt: 0.05                  # Micro timestep: 0.05s
  save_every: 1
  neighbor_rebuild: 5
  integrator: "euler"

# Vicsek alignment
params:
  R: 3.0
  alpha: 1.5
  beta: 0.5

# Noise
noise:
  kind: "gaussian"
  eta: 0.2
  match_variance: true

# Morse forces
forces:
  enabled: true
  type: "morse"
  params:
    Cr: 0.3
    Ca: 1.0
    lr: 0.5
    la: 2.0
    rcut_factor: 3.0
    mu_t: 0.3

alignment:
  enabled: true

# Outputs
outputs:
  run_name: "alvarez_ratios"
  order_parameters: true
  save_npz: true
  fps: 20
  density_resolution: 48
  density_bandwidth: 2.0

# ============================================================================
# TRAINING: Mixed distributions (400 runs)
# ============================================================================
train_ic:
  type: "mixed_comprehensive"
  
  # -------------------------------------------------------------------------
  # GAUSSIAN DISTRIBUTIONS (200 runs = 50%)
  # -------------------------------------------------------------------------
  gaussian:
    enabled: true
    n_runs: 200
    positions_x: [3.75, 7.5, 11.25, 15.0, 18.75]
    positions_y: [3.75, 7.5, 11.25, 15.0, 18.75]
    variances: [0.5, 1.0, 2.0, 3.0]
    n_samples_per_config: 2
  
  # -------------------------------------------------------------------------
  # UNIFORM DISTRIBUTIONS (100 runs = 25%)
  # -------------------------------------------------------------------------
  uniform:
    enabled: true
    n_runs: 100
    n_samples: 100
  
  # -------------------------------------------------------------------------
  # RING DISTRIBUTIONS (50 runs = 12.5%)
  # -------------------------------------------------------------------------
  ring:
    enabled: true
    n_runs: 50
    radii: [2.0, 3.0, 4.0, 5.0, 6.0]
    widths: [0.3, 0.6]
    n_samples_per_config: 5
  
  # -------------------------------------------------------------------------
  # TWO-CLUSTER DISTRIBUTIONS (50 runs = 12.5%)
  # -------------------------------------------------------------------------
  two_clusters:
    enabled: true
    n_runs: 50
    separations: [3.0, 4.5, 6.0, 7.5, 9.0]
    sigmas: [0.8, 1.5]
    n_samples_per_config: 5

# ============================================================================
# TESTING: Stratified test set (40 runs)
# ============================================================================
test_ic:
  type: "mixed_test_comprehensive"
  
  # -------------------------------------------------------------------------
  # GAUSSIAN TEST (20 runs)
  # -------------------------------------------------------------------------
  gaussian:
    enabled: true
    n_runs: 20
    test_positions_x: [5.5, 9.0, 13.0, 16.5]
    test_positions_y: [5.5, 9.0, 13.0, 16.5]
    test_variances: [1.5]
    extrapolation_positions: [[2.0, 2.0], [13.0, 2.0], [2.0, 13.0], [13.0, 13.0]]
    extrapolation_variance: [1.5]
  
  # -------------------------------------------------------------------------
  # UNIFORM TEST (5 runs)
  # -------------------------------------------------------------------------
  uniform:
    enabled: true
    n_runs: 5
  
  # -------------------------------------------------------------------------
  # RING TEST (8 runs)
  # -------------------------------------------------------------------------
  ring:
    enabled: true
    n_runs: 8
    test_radii: [2.5, 3.5, 4.5, 5.5]
    test_widths: [0.45]
    n_samples_per_config: 2
  
  # -------------------------------------------------------------------------
  # TWO-CLUSTER TEST (7 runs)
  # -------------------------------------------------------------------------
  two_clusters:
    enabled: true
    n_runs: 7
    test_separations: [3.75, 5.25, 6.75, 8.25]
    test_sigmas: [1.1]
    extrapolation_separations: [2.0, 10.5, 12.0]
    extrapolation_sigma: [1.1]

# ============================================================================
# DENSITY ESTIMATION
# ============================================================================
density:
  enabled: true
  nx: 48
  ny: 48
  method: "kde"
  bandwidth: 2.0

# ============================================================================
# ROM-MVAR CONFIGURATION - ALVAREZ RATIOS
# ============================================================================

rom:
  # ROM temporal subsampling
  subsample: 1              # No subsampling → Δt_ROM = 0.05s (capture all dynamics)
  
  # POD parameters (moderate latent space for 48x48 grid)
  pod_energy: 0.97          # Informational only (ignored when fixed_d set)
  fixed_d: 40               # FIXED: d = 40 (moderate latent for 48x48=2304 dims)
  
  # MVAR parameters (very short lag, dense sampling, strong regularization)
  mvar_lag: 4               # w = 4 (very short lag for fast dynamics)
  ridge_alpha: 0.5          # Strong regularization to prevent overfitting
  
  # Companion matrix stabilization (Step 5)
  eigenvalue_threshold: 0.98  # Scale spectral radius to ≤0.98

# ============================================================================
# NOTES
# ============================================================================
# Configuration targeting ratio 0.10 with strong regularization:
#   - Reduced spatial grid: 48×48 (2304 dims)
#   - Moderate latent dimension: d = 40
#   - Very short lag: w = 4 (was 8)
#   - Shorter trajectories: T = 10s (was 25s) → T_ROM = 200 steps
#   - NO temporal subsampling: subsample = 1 (captures all dynamics)
#   - Windows per run: 196 (vs 92 with subsample=5)
#   - Total samples: 78,400 (vs 36,800)
#   - Parameters: 6,400 (40² × 4)
#   - Ratio: 0.0816 ✓ (IN ALVAREZ 0.06-0.14 BAND!)
#   - Strong regularization: α = 0.5 (was 0.05)
#
# Improvements:
#   ✓ Ratio 0.0816 in strict Alvarez band
#   ✓ 2× more training samples (78,400 vs 36,800)
#   ✓ Half the parameters (6,400 vs 12,800)
#   ✓ No temporal subsampling loss
#   ✓ Strong regularization prevents overfitting
#   ✓ Faster runtime (10s vs 25s trajectories)
#   ✓ Good POD energy (~60-70%)
# ============================================================================
