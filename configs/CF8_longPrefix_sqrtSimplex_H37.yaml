---
# ============================================================================
# CF8 — LONG-PREFIX MULTI-IC (√ρ + Simplex, d=19, p=5)
# ============================================================================
#
# NOTE ON HORIZON:  The experiment name says "H37" but the actual forecast
#   horizon is H=42 steps.  Here's the math:
#     T=77s, dt=0.04, subsample=3  →  rom_dt=0.12s
#     Total ROM frames = floor(77/0.12)+1 = 642
#     T_train = floor(72.0 / 0.12) = 600
#     H = 642 - 600 = 42  steps  (= 5.04s)
#   The "H37" label is retained in the directory name to avoid breaking
#   existing OSCAR output and downstream references.
#
# This config replicates the CF8 experiment from suite_CONT_fix_v1 using the
# standard ROM pipeline (run_data_generation + run_visualizations).
#
# KEY INSIGHT FROM CF8:
#   Multi-IC training on 176 diverse trajectories (mixed_comprehensive ICs)
#   with a long prefix (72s = 600 ROM frames each) makes the MVAR regression
#   massively overdetermined: ~104k samples for 95 features.
#   With α=0.01, spectral radius ρ(C) = 1.118 (unstable — no
#   eigenvalue_threshold was set).  Despite this, rollout R² ≈ +0.52 over
#   42 steps thanks to the short horizon and simplex projection acting as
#   a nonlinear brake.
#
# CF8 PARAMETERS:
#   - V1 regime: N=100, speed=1.5, R=2.5, η=0.2, Morse(Ca=0.8,Cr=0.3)
#   - Training duration: T_train = 72s → 600 ROM frames after subsample=3
#   - Forecast horizon: H=42 steps → 42 × 0.12 = 5.04s  (NOT 37)
#   - Total sim time: 77s (72s train + 5s forecast)
#   - POD: d=19 fixed modes, √ρ transform
#   - MVAR: p=5 lag, α=0.01 ridge
#   - Post-processing: simplex projection (mass conservation)
#
# MVAR MATH (multi-IC):
#   d=19, p=5: n_features = 19 × 5 = 95
#   176 training ICs × (600 − 5) frames each = ~104,720 usable samples
#   Overdetermination ratio: 104720/95 ≈ 1102× (massively overdetermined)
#   NOTE: per-trajectory ratio is 595/95 = 6.26×; the multi-IC pooling
#   is what makes the regression so well-conditioned.
#
# TIMING ESTIMATE (~176 ICs × 77s sim):
#   Single sim: ~60s (N=100, 1925 steps)
#   Training sims: 176 × 60s = ~2.9h
#   Test sims: 30 × 60s = ~30min
#   POD + MVAR: ~5min
#   Eval: ~10min
#   Total: ~4.5h — fits in 8h time limit
#
# MEMORY ESTIMATE:
#   Snapshot matrix: 176 ICs × 600 frames × 2304 = 243M floats ≈ 1.9GB
#   SVD workspace: ~3× = ~6.6GB
#   Peak: ~12-15GB → safe at 32GB
#
# ============================================================================

experiment_name: "CF8_longPrefix_sqrtSimplex_H37"

# ============================================================================
# SIMULATION — V1 Regime (slow, moderate clustering)
# ============================================================================
sim:
  N: 100
  T: 77.0                  # 72s train + 5s forecast buffer
  dt: 0.04
  Lx: 15.0
  Ly: 15.0
  bc: "periodic"

# Test uses same long duration (train prefix + forecast horizon both in test)
# No separate test_sim block needed: we use forecast_start=72.0 to split

model:
  type: "discrete"
  speed: 1.5
  speed_mode: "constant_with_forces"

params:
  R: 2.5

noise:
  kind: "gaussian"
  eta: 0.2
  match_variance: true

forces:
  enabled: true
  type: "morse"
  params:
    Ca: 0.8
    Cr: 0.3
    la: 1.5
    lr: 0.5
    mu_t: 0.3
    rcut_factor: 5.0

alignment:
  enabled: true

# ============================================================================
# DENSITY — 48×48 grid
# ============================================================================
density:
  nx: 48
  ny: 48
  bandwidth: 4.0

outputs:
  density_resolution: 48
  density_bandwidth: 4.0

# ============================================================================
# TRAINING ICs — 176 mixed ICs (multi-IC training)
# ============================================================================
#
# Multi-IC training: 176 diverse ICs (96 gaussian + 50 uniform + 30 two_cluster)
# generated by mixed_comprehensive.  Each trajectory runs for 77s and provides
# 600 ROM frames of conditioning data.  The MVAR is fit to ALL trajectories
# simultaneously.  Test evaluation uses 30 HELD-OUT ICs.
#
# NOTE: gaussian n_runs=120 is advisory but ignored by the IC generator, which
#   produces 4 × 4 × 3 × 2 = 96 gaussian ICs from the combinatorial grid.
#   Actual total: 96 + 50 + 30 = 176.
#
# ============================================================================
train_ic:
  type: "mixed_comprehensive"
  gaussian:
    enabled: true
    n_runs: 120
    positions_x: [3.0, 6.0, 9.0, 12.0]
    positions_y: [3.0, 6.0, 9.0, 12.0]
    variances: [0.8, 1.5, 2.5]
    n_samples_per_config: 2
  uniform:
    enabled: true
    n_runs: 50
    n_samples: 50
  two_clusters:
    enabled: true
    n_runs: 30
    separations: [3.0, 5.0, 7.0]
    sigmas: [1.0, 2.0]
    n_samples_per_config: 5
  ring:
    enabled: false

# ============================================================================
# TEST ICs — 30 held-out ICs
# ============================================================================
test_ic:
  type: "mixed_test_comprehensive"
  gaussian:
    enabled: true
    n_runs: 15
    test_positions_x: [4.5, 7.5, 10.5]
    test_positions_y: [4.5, 7.5, 10.5]
    test_variances: [1.2]
    n_samples_per_config: 1
    extrapolation_positions:
      - [2.0, 2.0]
      - [13.0, 2.0]
      - [2.0, 13.0]
      - [13.0, 13.0]
      - [7.5, 1.5]
      - [1.5, 7.5]
    extrapolation_variance: [1.2]
  uniform:
    enabled: true
    n_runs: 8
  two_clusters:
    enabled: true
    n_runs: 7
    test_separations: [4.0, 6.0]
    test_sigmas: [1.5]
    n_samples_per_config: 3
    extrapolation_separations: [2.0]
    extrapolation_sigma: [1.5]
  ring:
    enabled: false

# ============================================================================
# ROM — CF8 Champion Configuration
# ============================================================================
rom:
  subsample: 3              # dt=0.04, subsample=3 → ROM_DT=0.12s
  fixed_modes: 19           # d=19 POD modes
  density_transform: "sqrt" # √ρ transform (CF8 key ingredient)
  density_transform_eps: 1.0e-10

  models:
    mvar:
      enabled: true
      lag: 5                # p=5 MVAR lag
      ridge_alpha: 0.01     # α=1e-2 (CF8 value — stronger than K-series 1e-4)
    lstm:
      enabled: false

# ============================================================================
# EVALUATION — CF8 style: long prefix + simplex
# ============================================================================
eval:
  metrics: ["r2", "rmse"]
  save_forecasts: true
  save_time_resolved: true
  forecast_start: 72.0      # Train on first 72s (600 ROM frames), forecast from there
  clamp_negative: true       # Clamp + renorm (C2 mode)
  mass_postprocess: simplex  # Simplex projection for mass conservation (CF8 key ingredient)
