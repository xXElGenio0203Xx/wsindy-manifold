# ============================================================================
# STABLE ROM-MVAR v2: Explicit Stability Enforcement
# ============================================================================
# Based on robust_mvar_v1 analysis:
#   - Ridge α=0.05 reduced norms but NOT eigenvalues
#   - Max eigenvalue: 1.297 > 1 (unstable)
#   - Test R² = 0.033 (still terrible)
#
# NEW STRATEGY:
#   1. Reduce complexity: 89 → 40 POD modes, lag 4 → 2
#   2. Much stronger regularization: α = 0.5 (10× stronger)
#   3. Post-processing: Scale eigenvalues if > 0.95
#   4. Keep mixed distributions + spatial coverage
# ============================================================================

# Model
model:
  type: discrete
  speed: 2.0  # Increased speed for faster simulations
  speed_mode: constant_with_forces

# Simulation parameters (OPTIMIZED)
sim:
  N: 150                    # Reduced from 300
  Lx: 15.0                  # Half domain
  Ly: 15.0                  # Half domain
  bc: "periodic"
  T: 1.0                    # TEST RUN: 1s (change to 50s after verification)
  dt: 0.05
  save_every: 1
  neighbor_rebuild: 5
  integrator: "euler"

# Vicsek alignment
params:
  R: 3.0
  alpha: 1.5
  beta: 0.5

# Noise
noise:
  kind: "gaussian"
  eta: 0.2
  match_variance: true

# Morse forces
forces:
  enabled: true
  type: "morse"
  params:
    Cr: 0.3
    Ca: 1.0
    lr: 0.5
    la: 2.0
    rcut_factor: 3.0
    mu_t: 0.3

alignment:
  enabled: true

# Outputs
outputs:
  run_name: "stable_mvar_v2"
  order_parameters: true
  save_npz: true
  fps: 20
  density_resolution: 64    # Reduced from 128
  density_bandwidth: 2.0

# ============================================================================
# TRAINING: Same mixed distributions as robust_v1
# ============================================================================
train_ic:
  type: "mixed_comprehensive"
  
  # Gaussian clusters (200 runs = 50% of training)
  gaussian_cluster:
    count: 200
    positions:
      # 5×5 spatial grid for translation invariance
      x_values: [3.75, 7.5, 11.25, 15.0, 18.75]
      y_values: [3.75, 7.5, 11.25, 15.0, 18.75]
      samples_per_position: 2
    variances: [0.5, 1.0, 2.0, 3.0]
    
  # Uniform distribution (100 runs = 25% of training)
  uniform:
    count: 100
    seeds: [100, 101, 102, 103, 104, 105, 106, 107, 108, 109,
            110, 111, 112, 113, 114, 115, 116, 117, 118, 119,
            120, 121, 122, 123, 124, 125, 126, 127, 128, 129,
            130, 131, 132, 133, 134, 135, 136, 137, 138, 139,
            140, 141, 142, 143, 144, 145, 146, 147, 148, 149,
            150, 151, 152, 153, 154, 155, 156, 157, 158, 159,
            160, 161, 162, 163, 164, 165, 166, 167, 168, 169,
            170, 171, 172, 173, 174, 175, 176, 177, 178, 179,
            180, 181, 182, 183, 184, 185, 186, 187, 188, 189,
            190, 191, 192, 193, 194, 195, 196, 197, 198, 199]
    
  # Ring distribution (50 runs = 12.5% of training)
  ring:
    count: 50
    radii: [2.0, 3.0, 4.0, 5.0, 6.0]
    widths: [0.3, 0.6]
    samples_per_config: 5
    
  # Two clusters (50 runs = 12.5% of training)
  two_clusters:
    count: 50
    separations: [3.0, 4.5, 6.0, 7.5, 9.0]
    sigmas: [0.8, 1.5]
    samples_per_config: 5

# ============================================================================
# ROM SETTINGS: REDUCED COMPLEXITY + VERY STRONG REGULARIZATION
# ============================================================================
rom:
  pod_energy: 0.99          # REDUCED: 99% vs 99.5% → fewer modes
  mvar_lag: 2               # REDUCED: lag=2 vs lag=4 → simpler dynamics
  ridge_alpha: 0.5          # VERY STRONG: 10× stronger than v1
  eigenvalue_threshold: 0.95  # Scale down if any |λ| > 0.95
  
# ============================================================================
# TEST: Same as robust_v1
# ============================================================================
test_ic:
  # Gaussian interpolation (10 runs)
  gaussian_cluster_interp:
    count: 10
    positions:
      x_values: [5.0, 10.0, 15.0]
      y_values: [5.0, 10.0, 15.0]
    variances: [1.5, 2.5]
    
  # Gaussian extrapolation (10 runs)
  gaussian_cluster_extrap:
    count: 10
    positions:
      x_values: [2.0, 13.0]
      y_values: [2.0, 13.0]
    variances: [0.3, 4.0]
    
  # Uniform (5 runs)
  uniform:
    count: 5
    seeds: [500, 501, 502, 503, 504]
    
  # Ring (8 runs)
  ring:
    count: 8
    radii: [2.5, 3.5, 4.5, 5.5]
    widths: [0.4, 0.5]
    
  # Two clusters (7 runs)
  two_clusters:
    count: 7
    separations: [4.0, 5.5, 7.0]
    sigmas: [1.0, 1.2]

# ============================================================================
# EXPECTED RESULTS (with reduced complexity + strong regularization)
# ============================================================================
# POD: ~40-50 modes (99% energy vs 99.5%)
# Training R²: ~0.95-0.97 (lower due to strong α, but acceptable)
# Max eigenvalue: < 0.95 (STABLE by design)
# Test R²: > 0.5 (hopefully!)
# ============================================================================
