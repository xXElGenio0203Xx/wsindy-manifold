# ============================================================================
# STABLE ROM-MVAR v2: Explicit Stability Enforcement
# ============================================================================
# Based on robust_mvar_v1 analysis:
#   - Ridge α=0.05 reduced norms but NOT eigenvalues
#   - Max eigenvalue: 1.297 > 1 (unstable)
#   - Test R² = 0.033 (still terrible)
#
# NEW STRATEGY:
#   1. Reduce complexity: 89 → 40 POD modes, lag 4 → 2
#   2. Much stronger regularization: α = 0.5 (10× stronger)
#   3. Post-processing: Scale eigenvalues if > 0.95
#   4. Keep mixed distributions + spatial coverage
# ============================================================================

# Model
model:
  type: discrete
  speed: 2.0  # Increased speed for faster simulations
  speed_mode: constant_with_forces

# Simulation parameters (OPTIMIZED)
sim:
  N: 150                    # Reduced from 300
  Lx: 15.0                  # Half domain
  Ly: 15.0                  # Half domain
  bc: "periodic"
  T: 5.0                    # 5 seconds for more training data
  dt: 0.05
  save_every: 1
  neighbor_rebuild: 5
  integrator: "euler"

# Vicsek alignment
params:
  R: 3.0
  alpha: 1.5
  beta: 0.5

# Noise
noise:
  kind: "gaussian"
  eta: 0.2
  match_variance: true

# Morse forces
forces:
  enabled: true
  type: "morse"
  params:
    Cr: 0.3
    Ca: 1.0
    lr: 0.5
    la: 2.0
    rcut_factor: 3.0
    mu_t: 0.3

alignment:
  enabled: true

# Outputs
outputs:
  run_name: "stable_mvar_v2"
  order_parameters: true
  save_npz: true
  fps: 20
  density_resolution: 32    # Reduced to 32x32 grid
  density_bandwidth: 2.0

# ============================================================================
# TRAINING: Same mixed distributions as robust_v1 (400 runs)
# ============================================================================
train_ic:
  type: "mixed_comprehensive"
  
  # -------------------------------------------------------------------------
  # GAUSSIAN DISTRIBUTIONS (200 runs = 50%)
  # -------------------------------------------------------------------------
  gaussian:
    enabled: true
    n_runs: 200
    
    # 5×5 spatial grid
    positions_x: [3.75, 7.5, 11.25, 15.0, 18.75]
    positions_y: [3.75, 7.5, 11.25, 15.0, 18.75]
    
    # 4 variances per position
    variances: [0.5, 1.0, 2.0, 3.0]
    
    # Calculation: 5×5 positions × 4 variances × 2 samples = 200 runs
    n_samples_per_config: 2
  
  # -------------------------------------------------------------------------
  # UNIFORM DISTRIBUTIONS (100 runs = 25%)
  # -------------------------------------------------------------------------
  uniform:
    enabled: true
    n_runs: 100
    
    # Sample uniform at different random seeds
    n_samples: 100
  
  # -------------------------------------------------------------------------
  # RING DISTRIBUTIONS (50 runs = 12.5%)
  # -------------------------------------------------------------------------
  ring:
    enabled: true
    n_runs: 50
    
    # 5 different radii
    radii: [2.0, 3.0, 4.0, 5.0, 6.0]
    
    # 2 different widths per radius
    widths: [0.3, 0.6]
    
    # Calculation: 5 radii × 2 widths × 5 samples = 50 runs
    n_samples_per_config: 5
  
  # -------------------------------------------------------------------------
  # TWO-CLUSTER DISTRIBUTIONS (50 runs = 12.5%)
  # -------------------------------------------------------------------------
  two_clusters:
    enabled: true
    n_runs: 50
    
    # 5 different separations
    separations: [3.0, 4.5, 6.0, 7.5, 9.0]
    
    # 2 different cluster sizes
    sigmas: [0.8, 1.5]
    
    # Calculation: 5 separations × 2 sigmas × 5 samples = 50 runs
    n_samples_per_config: 5

# ============================================================================
# TESTING: Same as robust_v1 (40 runs)
# ============================================================================
test_ic:
  type: "mixed_test_comprehensive"
  
  # -------------------------------------------------------------------------
  # GAUSSIAN TEST (20 runs)
  # -------------------------------------------------------------------------
  gaussian:
    enabled: true
    n_runs: 20
    
    # Test on interpolated positions (between training grid)
    test_positions_x: [5.5, 9.0, 13.0, 16.5]
    test_positions_y: [5.5, 9.0, 13.0, 16.5]
    
    # Test variance (not in training set)
    test_variances: [1.5]
    
    # Plus 4 extrapolation tests (corners)
    extrapolation_positions: [[2.0, 2.0], [13.0, 2.0], [2.0, 13.0], [13.0, 13.0]]
    extrapolation_variance: [1.5]
  
  # -------------------------------------------------------------------------
  # UNIFORM TEST (5 runs)
  # -------------------------------------------------------------------------
  uniform:
    enabled: true
    n_runs: 5
  
  # -------------------------------------------------------------------------
  # RING TEST (8 runs)
  # -------------------------------------------------------------------------
  ring:
    enabled: true
    n_runs: 8
    
    # Interpolation: radii between training values
    test_radii: [2.5, 3.5, 4.5, 5.5]
    test_widths: [0.45]
    n_samples_per_config: 2
  
  # -------------------------------------------------------------------------
  # TWO-CLUSTER TEST (7 runs)
  # -------------------------------------------------------------------------
  two_clusters:
    enabled: true
    n_runs: 7
    
    # Test on interpolated separations
    test_separations: [3.75, 5.25, 6.75, 8.25]
    test_sigmas: [1.1]
    
    # Plus 3 extrapolation tests
    extrapolation_separations: [2.0, 10.5, 12.0]
    extrapolation_sigma: [1.1]

# ============================================================================
# DENSITY ESTIMATION
# ============================================================================
density:
  enabled: true
  nx: 32
  ny: 32
  method: "kde"
  bandwidth: 2.0

# ============================================================================
# ROM SETTINGS: HIGH ENERGY POD + ALL SNAPSHOTS + MODERATE LAG
# ============================================================================
rom:
  subsample: 1              # Use all snapshots (no temporal subsampling)
  pod_energy: 0.99          # 99% energy capture (high quality POD)
  mvar_lag: 12              # Moderate lag window
  ridge_alpha: 0.4          # Strong regularization
  eigenvalue_threshold: 0.95  # Scale down if any |λ| > 0.95
  
# ============================================================================
# EXPECTED RESULTS (32x32 grid, POD=99%, T=5s, w=12, subsample=1, α=0.4)
# ============================================================================
# Grid: 32×32 = 1024 dimensions (reduced from 64×64 = 4096)
# POD: ~25-30 modes at 99% energy (much smaller space)
# Timesteps: 5s / 0.05s = 100 steps per run
# Windows per run: 100 - 12 = 88
# Total samples: 400 × 88 = 35,200
# Parameters: ~25² × 12 ≈ 7,500 (if d≈25)
# Ratio: ~0.21 (reasonable)
# 
# Advantages:
#   - Smaller grid → much better POD compression
#   - 99% energy → high quality basis
#   - All snapshots → no temporal information loss
#   - Moderate lag (12) → good temporal memory
#   - Strong regularization (0.4) → prevent overfitting
# ============================================================================
