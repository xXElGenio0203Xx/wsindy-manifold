# Discrete Vicsek-Morse Base Configuration for ROM/MVAR Ensemble Training
# 
# This configuration uses DISCRETE-TIME VICSEK MODEL WITH MORSE FORCES
# - Variable speed mode: Forces affect velocity (discrete D'Orsogna-like)
# - Periodic boundary conditions (20x20 domain)
# - N=200 particles
# - Balanced Morse forces (Cr=0.5, Ca=1.0) for moderate attraction
# - Built-in Vicsek alignment (radius=2.0)
# - Gaussian angular noise (eta=0.3)
# 
# Purpose: Serve as the base model for ensemble simulations where ONLY
# initial conditions vary (seeds, IC types). All physics parameters below
# remain FIXED across the ensemble.
#
# Usage with ROM/MVAR pipeline (on Oscar):
#   1. Train: python scripts/rom_mvar_train.py --config configs/vicsek_morse_base.yaml
#   2. Eval:  python scripts/rom_mvar_eval.py --experiment vicsek_morse_base --config configs/vicsek_morse_base.yaml
#
# Runtime estimates (Oscar with Slurm arrays):
#   - Per simulation: ~1-2 minutes with discrete integrator (T=300)
#   - 50 training runs: ~1-2 minutes total (PARALLEL via array job!)
#   - POD + MVAR fitting: ~5-10 minutes
#   - Evaluation: ~5 minutes
#   - Total training pipeline: ~20-25 minutes end-to-end

# ==============================================================================
# FIXED MODEL PARAMETERS (keep constant across ensemble)
# ==============================================================================

# Use discrete-time Vicsek model with forces enabled
model: vicsek_discrete

# Simulation domain and time
sim:
  N: 200                    # Number of particles
  Lx: 20.0                  # Domain width (periodic)
  Ly: 20.0                  # Domain height (periodic)
  bc: periodic              # Periodic boundary conditions
  T: 300.0                  # Simulation time (increased for richer dynamics)
  dt: 0.1                   # Time step (discrete updates, can be larger than continuous)
  save_every: 10            # Save every 10 steps → 3000 snapshots total
  integrator: euler_semiimplicit  # Options: "euler" (explicit) or "euler_semiimplicit" (more stable with forces)
  neighbor_rebuild: 1       # Rebuild neighbors every step (critical for discrete)

# Model configuration (discrete Vicsek with variable speed)
model_config:
  speed: 0.5                # Natural particle speed v0
  speed_mode: variable      # "variable": forces affect velocity; "constant": fixed speed

# Alignment parameters (built into discrete Vicsek)
params:
  R: 2.0                    # Alignment interaction radius

# Noise configuration (angular noise for heading updates)
noise:
  kind: gaussian            # Options: "gaussian" (σ) or "uniform" (η)
  eta: 0.3                  # Noise strength (angular spread in radians)
  match_variance: true      # Match Gaussian/uniform variance for consistency

# Morse force configuration
forces:
  enabled: true             # Enable Morse forces
  type: morse               # Force type
  params:
    Cr: 0.5                 # Repulsion strength
    Ca: 1.0                 # Attraction strength (C = Cr/Ca = 0.5)
    lr: 0.5                 # Repulsion length scale
    la: 1.0                 # Attraction length scale (ℓ = lr/la = 0.5)
    rcut_factor: 3.0        # Cutoff at 3 * la
    mu_t: 0.5               # Translational mobility (force-velocity coupling)

# ==============================================================================
# VARIABLE PARAMETERS (for ensemble IC generation)
# ==============================================================================

# Seed: Will be overridden by ensemble driver
seed: 42

# Initial condition: Will be varied for ensemble diversity
initial_distribution: uniform  # Options: uniform, gaussian, ring, cluster

# Ensemble settings (for training)
ensemble:
  n_runs: 50                # Number of training simulations (50 runs × ~6s = ~5 minutes)
  seeds: null               # null = auto-generate [0,1,2,...,49]; or explicit list
  base_seed: 0              # Starting seed if auto-generating
  ic_types:                 # IC types to sample from
    - uniform
    - gaussian
    - ring
    - cluster
  ic_weights: null          # null = uniform sampling; or [0.4, 0.3, 0.2, 0.1]

# ==============================================================================
# OUTPUT SETTINGS (Oscar-optimized for ROM pipeline)
# ==============================================================================

out_dir: simulations/vicsek_morse_base

outputs:
  # Basic file outputs
  save_npz: true
  save_csv: true
  plots: false              # Disable plots during ensemble training
  
  # Video controls (disable for Oscar, generate later with visualize)
  animate_traj: false
  animate_density: false
  video_ics: 0              # Don't generate any videos during training
  
  # Order parameter plots (disable for Oscar)
  plot_order_params: false
  order_params_ics: 0
  
  # Density grid for POD
  grid_density:
    enabled: true
    nx: 64                  # 64x64 grid (4096 spatial DOFs)
    ny: 64
    bandwidth: 0.5          # KDE bandwidth
  
  # Disable legacy EF-ROM auto-run
  efrom:
    auto_run: false

# ==============================================================================
# ROM/MVAR PIPELINE SETTINGS
# ==============================================================================

rom:
  experiment_name: vicsek_morse_base
  rom_root: rom_mvar
  
  # Training settings
  num_train_ics: 50         # Number of training simulations with varied ICs (must match ensemble.n_runs)
  train_seeds: null         # null = [0, 1, 2, ..., 49]; or explicit list
  
  # POD settings
  energy_threshold: 0.995   # Retain 99.5% of energy
  latent_dim: null          # null = use energy_threshold; int = fixed dimension
  
  # MVAR settings
  mvar_order: 4             # Number of lags (p)
  ridge: 1.0e-6             # Ridge regularization
  train_frac: 1.0           # Use all time steps for training
  
  # Evaluation settings
  eval:
    num_test_ics: 2         # Number of unseen test ICs
    test_seeds: null        # null = [1000, 1001]; or explicit list
    forecast_horizon: null  # null = forecast to end of simulation
    error_tolerance: 0.1    # Tolerance for computing τ
    error_metric: rmse      # Metric for τ: 'rmse', 'r2', 'e2', 'einf', 'mass_error'
    generate_videos: false  # False for Oscar
    generate_plots: false   # False for Oscar

# ==============================================================================
# PARAMETER RATIONALE
# ==============================================================================
#
# Discrete Vicsek Model with Forces (THIS CONFIG):
#
# Physics (variable speed mode):
#   1. Compute Morse forces: F = Σ_j [-C_r*e^(-r/l_r) + C_a*e^(-r/l_a)] r̂_ij
#   2. Update velocities: v_{n+1} = v_n + dt * μ_t * F_n
#   3. Compute mean neighbor heading: p̄_i = normalize(Σ_{j∈N(i)} p_j)
#   4. Align velocity toward p̄ with angular noise: v → |v| * R(noise) @ p̄
#   5. Update positions: x_{n+1} = x_n + dt * v_{n+1}
#
# Key Features:
#   - Variable speed: Forces directly change velocity magnitude
#   - Built-in alignment: Heading follows neighbor average (no explicit alignment force)
#   - Angular noise: Gaussian noise on heading angles (eta = 0.3 rad)
#   - Semi-implicit integrator: Update velocity first (more stable with forces)
#   - Discrete time: Larger dt possible (0.1 vs 0.01 for continuous)
#   - Runtime: ~3-6s/run (faster than continuous models!)
#
# Speed Modes:
#   - "constant" (not used): Fixed |v| = v0, forces only shift positions
#   - "variable" (this config): Forces change |v|, like discrete D'Orsogna
#
# Integrator Options (discrete model):
#   - "euler": Explicit Euler (standard forward integration)
#   - "euler_semiimplicit": Update velocity first, then position (MORE STABLE with forces)
#
# Comparison to social_force:
#   - Continuous ODE: dx/dt = v, dv/dt = (α - β|v|²)v + F + alignment_force
#   - Self-propulsion: (α - β|v|²)v drives to speed ~sqrt(α/β)
#   - Runtime: ~5-8s/run (euler), ~8-12s/run (rk4)
#   - Requires smaller dt = 0.01 for stability
#
# Domain (20x20, periodic):
#   - Large enough to avoid finite-size effects for 200 particles
#   - Periodic BCs allow natural cluster formation without wall effects
#   - Density ρ = N/(Lx*Ly) = 200/400 = 0.5 particles per unit area
#
# Morse Forces (Cr=0.5, Ca=1.0, lr=0.5, la=1.0):
#   - C = Cr/Ca = 0.5 → moderate net attraction (not too strong)
#   - ℓ = lr/la = 0.5 → repulsion range is half of attraction range
#   - These ratios favor gentle clustering into ~2 groups
#   - rcut_factor=3.0 → interactions cut off at 3*la = 3.0
#
# Alignment (radius=2.0, rate=1.0):
#   - R_align = 2.0 → local alignment over ~2 length units
#   - rate = 1.0 → strong alignment (balances with noise)
#   - Helps maintain coherent cluster motion
#
# Noise (implicit in Vicsek dynamics):
#   - For social_force model, noise is handled via initial velocities
#   - IC randomness provides diversity across ensemble
#
# Self-Propulsion (alpha=1.5, beta=0.5):
#   - alpha = 1.5 → moderate self-propulsion
#   - beta = 0.5 → moderate drag
#   - Steady-state speed ≈ sqrt(alpha/beta) ≈ 1.73
#
# Grid Resolution (64x64):
#   - 4096 spatial DOFs → typically reduces to ~10-20 latent modes
#   - Compression ratio ~200-400x
#   - Sufficient for capturing cluster structure
#
# Expected Behavior:
#   - Formation of 1-3 clusters (typically 2)
#   - Clusters slowly migrate and occasionally merge/split
#   - Alignment keeps clusters coherent
#   - Moderate attraction prevents full dispersion
#   - Not too strong to cause collapse into single dense blob
#
# Tuning Knobs (if behavior is not as desired):
#   - More clusters: Increase noise (lower alignment rate), decrease Ca
#   - Tighter clusters: Increase Ca, decrease lr/la ratio
#   - More disordered: Decrease alignment rate, increase noise
#   - Faster dynamics: Increase alpha, decrease T
