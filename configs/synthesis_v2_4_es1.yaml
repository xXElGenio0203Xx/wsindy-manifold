---
# ============================================================================
# SYNTHESIS V2.4_ES1 — V2.4 Champion + Eigenvalue Scaling to 1.0
# ============================================================================
#
# HYPOTHESIS:
#   V2.4 champion has spectral radius ρ = 1.2075 with 20/30 unstable
#   eigenvalues. V2.2 scaled to 0.97 and got R²=-0.015 (catastrophic).
#   
#   Scaling to 0.97 over-damps: ALL eigenvalues get compressed uniformly,
#   even modes that were already stable. This kills the dynamics.
#
#   Scaling to 1.0 = normalize to the unit circle boundary:
#     - Prevents exponential blowup (all |λ| ≤ 1)
#     - Preserves relative eigenvalue structure
#     - No artificial damping — marginally stable instead of damped
#     - Energy-preserving rather than energy-dissipating
#
#   Key insight: The 3% damping margin (0.97 vs 1.0) may be the
#   difference between "dynamics preserved" and "dynamics killed."
#
# CONTROL COMPARISON:
#   V2.2: eigenvalue_threshold=0.97 → R²=-0.015 (over-damped)
#   V2.4: no scaling (ρ=1.208)     → R²=+0.272 (champion, but unstable)
#   V2.4_es1: eigenvalue_threshold=1.0 → ??? (stable, no damping)
#
# MATH:
#   Companion matrix C is 30×30 (d=10, p=3).
#   Current ρ=1.2075 → scale factor = 1.0/1.2075 = 0.828
#   V2.2 used scale factor = 0.97/1.2075 = 0.803
#   Difference: 0.828 vs 0.803 (3% less compression)
#
# EVERYTHING ELSE: Identical to V2.4
# ============================================================================

experiment_name: "synthesis_v2_4_es1"

# ============================================================================
# SIMULATION — Identical to V2.4
# ============================================================================
sim:
  N: 100
  T: 6.0
  dt: 0.04
  Lx: 15.0
  Ly: 15.0
  bc: "periodic"

model:
  type: "discrete"
  speed: 1.5
  speed_mode: "constant_with_forces"

params:
  R: 2.5

noise:
  kind: "gaussian"
  eta: 0.2
  match_variance: true

forces:
  enabled: true
  type: "morse"
  params:
    Ca: 0.8
    Cr: 0.3
    la: 1.5
    lr: 0.5
    mu_t: 0.3
    rcut_factor: 5.0

alignment:
  enabled: true

# ============================================================================
# DENSITY — Identical to V2.4
# ============================================================================
density:
  nx: 48
  ny: 48
  bandwidth: 4.0

outputs:
  density_resolution: 48
  density_bandwidth: 4.0

# ============================================================================
# TRAINING ICs — Same 261 runs as V2.4
# ============================================================================
train_ic:
  type: "mixed_comprehensive"

  gaussian:
    enabled: true
    n_runs: 180
    positions_x: [3.0, 6.0, 9.0, 12.0]
    positions_y: [3.0, 6.0, 9.0, 12.0]
    variances: [0.8, 1.5, 2.5]
    n_samples_per_config: 3

  uniform:
    enabled: true
    n_runs: 75
    n_samples: 75

  two_clusters:
    enabled: true
    n_runs: 45
    separations: [3.0, 5.0, 7.0]
    sigmas: [1.0, 2.0]
    n_samples_per_config: 7

  ring:
    enabled: false

# ============================================================================
# TEST ICs — Same 26 runs as V2.4
# ============================================================================
test_ic:
  type: "mixed_test_comprehensive"

  gaussian:
    enabled: true
    n_runs: 15
    test_positions_x: [4.5, 7.5, 10.5]
    test_positions_y: [4.5, 7.5, 10.5]
    test_variances: [1.2]
    n_samples_per_config: 1
    extrapolation_positions: [[2.0, 2.0], [13.0, 2.0], [2.0, 13.0], [13.0, 13.0], [7.5, 1.5], [1.5, 7.5]]
    extrapolation_variance: [1.2]

  uniform:
    enabled: true
    n_runs: 8

  two_clusters:
    enabled: true
    n_runs: 7
    test_separations: [4.0, 6.0]
    test_sigmas: [1.5]
    n_samples_per_config: 3
    extrapolation_separations: [2.0]
    extrapolation_sigma: [1.5]

  ring:
    enabled: false

# ============================================================================
# ROM — EIGENVALUE SCALING TO 1.0 (the key change!)
# ============================================================================
rom:
  subsample: 3
  fixed_modes: 10

  # EIGENVALUE THRESHOLD = 1.0 — normalize to unit circle, no damping
  eigenvalue_threshold: 1.0

  models:
    mvar:
      enabled: true
      lag: 3
      ridge_alpha: 10.0
      eigenvalue_threshold: 1.0    # Also set at model level for safety

    lstm:
      enabled: true
      lag: 3
      hidden_units: 64
      num_layers: 2
      max_epochs: 3000
      patience: 100
      batch_size: 128
      learning_rate: 1.0e-3
      weight_decay: 1.0e-4
      gradient_clip: 1.0
      dropout: 0.1

# ============================================================================
# EVALUATION — WITH clamping (identical to V2.4)
# ============================================================================
eval:
  metrics: ["r2", "rmse"]
  save_forecasts: true
  save_time_resolved: true
  forecast_start: 0.36
  clamp_negative: true
