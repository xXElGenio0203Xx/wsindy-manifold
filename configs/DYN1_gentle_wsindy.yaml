---
# ============================================================================
# DYN1 — GENTLE + WSINDy PDE Discovery
# ============================================================================
# Same particle sim + MVAR ROM as DYN1_gentle, plus WSINDy PDE discovery
# on the raw density fields with a RICH candidate library.
# ============================================================================

experiment_name: "DYN1_gentle_wsindy"

sim:
  N: 200
  T: 20.0
  dt: 0.04
  Lx: 25.0
  Ly: 25.0
  bc: "periodic"

test_sim:
  T: 50.0      # long forecast horizon

model:
  type: "discrete"
  speed: 1.5
  speed_mode: "constant_with_forces"

params:
  R: 4.0

noise:
  kind: "gaussian"
  eta: 0.1
  match_variance: true

forces:
  enabled: true
  type: "morse"
  params:
    Ca: 0.8
    Cr: 0.3
    la: 1.5
    lr: 0.5
    mu_t: 0.3
    rcut_factor: 5.0

alignment:
  enabled: true

density:
  nx: 64
  ny: 64
  bandwidth: 5.0

outputs:
  density_resolution: 64
  density_bandwidth: 5.0

train_ic:
  type: "mixed_comprehensive"
  gaussian:
    enabled: true
    n_runs: 80
    positions_x: [5.0, 10.0, 15.0, 20.0]
    positions_y: [5.0, 10.0, 15.0, 20.0]
    variances: [1.5, 3.0, 5.0]
    n_samples_per_config: 1
  uniform:
    enabled: true
    n_runs: 40
    n_samples: 40
  two_clusters:
    enabled: true
    n_runs: 24
    separations: [4.0, 7.0, 10.0]
    sigmas: [1.5, 3.0]
    n_samples_per_config: 4
  ring:
    enabled: false

test_ic:
  type: "mixed_test_comprehensive"
  gaussian:
    enabled: false
  uniform:
    enabled: true
    n_runs: 20
  two_clusters:
    enabled: false
  ring:
    enabled: false

# ── ROM (MVAR) — same as DYN1_gentle ──────────────────────────────
rom:
  subsample: 3
  fixed_modes: 19
  density_transform: "raw"
  density_transform_eps: 1.0e-10
  shift_align: true
  shift_align_ref: "mean"
  mass_postprocess: "none"
  models:
    mvar:
      enabled: true
      lag: 5
      ridge_alpha: 1.0e-4
    lstm:
      enabled: false

eval:
  metrics: ["r2", "rmse"]
  save_forecasts: true
  save_time_resolved: true
  forecast_start: 0.60
  clamp_mode: "C0"

# ══════════════════════════════════════════════════════════════════
# WSINDy PDE Discovery Configuration — 3-field system
# ══════════════════════════════════════════════════════════════════
# Discovers a coupled 3-equation PDE system:
#
#   ρ_t   = c₁ ∇·p  + c₂ Δρ  + c₃ ∇·(ρ∇Φ)  + c₄ Δ(ρ²) + c₅ Δ(ρ³) + ...
#   p_x_t = d₁ p_x  + d₂ |p|²p_x + d₃ ∂_xρ  + d₄ Δp_x  + d₅ ρ∂_xΦ + ...
#   p_y_t = e₁ p_y  + e₂ |p|²p_y + e₃ ∂_yρ  + e₄ Δp_y  + e₅ ρ∂_yΦ + ...
#
# where Φ = W*ρ (Morse convolution) and p = Σ K_h(x-xᵢ)vᵢ (flux KDE).
# The 3-field formulation closes the system properly:
#   - ρ alone cannot recover velocity information → underdetermined
#   - p carries heading/alignment info that ρ lacks
#   - Morse Φ captures nonlocal attraction/repulsion correctly
# ══════════════════════════════════════════════════════════════════
wsindy:
  enabled: true
  mode: "multifield"       # "multifield" (3-eq) or "scalar" (ρ-only)

  # ── data handling ──────────────────────────────────────────────
  n_train: 30              # training trajectories for PDE discovery
  subsample: 3             # temporal subsampling (match ROM)
  seed: 42

  # ── Multi-field library (thesis-grade) ─────────────────────────
  # ρ equation:  ∇·p, Δρ, ∇·(ρ∇Φ), Δ(ρ²), Δ(ρ³)        = 5 terms
  # p_x equation: p_x, |p|²p_x, ∂_xρ, Δp_x, ρ∂_xΦ      = 5 terms
  # p_y equation: p_y, |p|²p_y, ∂_yρ, Δp_y, ρ∂_yΦ        = 5 terms
  # Total: 15 candidate terms (strong default)
  #
  # rich=true adds: Δ(|p|²), (p·∇)p, Δ²p, ∇(ρ²) → 24 terms
  multifield_library:
    morse: true              # include Φ = W*ρ terms (highest value)
    rich: false              # if true, adds dangerous optional terms

  # ── Scalar fallback library (ρ-only mode) ──────────────────────
  library:
    max_poly: 3
    operators: [I, dx, dy, dxx, dyy, lap]
    include_constant: true
    nonlinear_diffusion:
      enabled: true
      powers: [2, 3]
    gradient_nonlinearity:
      enabled: true
    conservative:
      enabled: true
      terms: ["dx:u2", "dy:u2", "dx:u3", "dy:u3"]
    custom_terms: []

  # ── model selection ───────────────────────────────────────────
  model_selection:
    n_ell: 12              # test-function scale configs to try
    p: [2, 2, 2]           # polynomial exponent for bump function
    stride: [2, 2, 2]      # query point stride

  # ── regularisation ────────────────────────────────────────────
  lambdas:
    log_min: -5
    log_max: 2
    n_points: 60

  # ── bootstrap UQ ──────────────────────────────────────────────
  bootstrap:
    enabled: true
    B: 50
    ci_alpha: 0.05

  # ── forecasting ───────────────────────────────────────────────
  forecast:
    clip_negative: true    # density ≥ 0
    mass_conserve: true    # enforce ∫ρ dx = const each step
    method: "auto"         # "auto" → ETDRK4 if Δ/Δ² terms, else RK4
                           # "rk4"  → always RK4
                           # "etdrk4" → always ETDRK4 (spectral stiff solver)
