---
# ============================================================================
# CLUSTERING V2 — Faster particles, strong clustering, better POD
# ============================================================================
#
# CHANGES FROM heavyweight_oscar.yaml:
#
# 1. FORCES ENABLED — Morse attraction+repulsion creates visible clustering
#    Ca=1.0 (attraction), Cr=0.3 (repulsion) → particles clump into groups
#    This was DISABLED in heavyweight → particles just drifted randomly
#
# 2. FASTER SPEED: 2.0 (was 1.0)
#    More dynamic behavior, particles traverse the domain faster
#
# 3. STRONGER ALIGNMENT: eta=0.15 (was 0.3)
#    Lower noise → particles align heading more strongly with neighbors
#    Combined with Morse forces → coherent moving clusters
#
# 4. POD ENERGY 0.65 (was 0.45)
#    47% energy gave only 4 modes → R²=0.56 reconstruction ceiling
#    65% energy → ~8-10 modes → higher ceiling while keeping d manageable
#
# 5. NEGATIVE DENSITY CLAMPING
#    Added in test_evaluator.py — clamps pred_physical >= 0 after POD recon
#
# 6. SHORTER FORECAST: T=10s, forecast_start=1.0
#    T=15s with 0.5s conditioning → 362-step forecast was too long
#    T=10s with 1.0s conditioning → ~225 steps, less autoregressive drift
#
# 7. LSTM: patience=50 (was 80), max_epochs=1500, h=128
#    Previous LSTM never converged in 2000 epochs. Bigger hidden state
#    to capture nonlinear cluster dynamics. Lower patience to stop earlier.
#
# ============================================================================

experiment_name: "clustering_v2"

# ============================================================================
# SIMULATION PARAMETERS
# ============================================================================
sim:
  N: 100                   # 100 particles → smooth density fields
  T: 10.0                  # 10 seconds — shorter for less autoregressive drift
  dt: 0.04                 # 251 frames/run
  Lx: 10.0
  Ly: 10.0
  bc: "periodic"

# Model type and speed (top-level — required by simulate_backend)
model:
  type: "discrete"
  speed: 2.0               # FASTER particles — more dynamic behavior
  speed_mode: "constant_with_forces"   # Forces steer heading, speed stays v0

# Alignment parameters
params:
  R: 2.0                   # Alignment radius

# Noise (top-level — required by simulate_backend)
noise:
  kind: "gaussian"
  eta: 0.15                # LOW noise → strong alignment
  match_variance: true

# MORSE FORCES — creates clustering! (top-level with params nested)
forces:
  enabled: true
  type: "morse"
  params:
    Ca: 1.0                # Attraction strength — pulls particles together
    Cr: 0.3                # Repulsion strength — prevents collapse
    la: 1.5                # Attraction length scale
    lr: 0.5                # Repulsion length scale
    mu_t: 0.3              # Force influence on heading
    rcut_factor: 5.0       # Force cutoff = 5 × max(la, lr)

# ============================================================================
# DENSITY FIELD — Smooth and low-rank
# ============================================================================
density:
  nx: 48                   # 48×48 grid
  ny: 48
  bandwidth: 3.0           # Wide KDE kernels → smooth fields

outputs:
  density_resolution: 48
  density_bandwidth: 3.0

# ============================================================================
# TRAINING: Gaussian-only, 80 runs
# ============================================================================
# 5 x-positions × 4 y-positions × 4 variances = 80 runs
# Slightly fewer runs but with forces → richer dynamics per run
# ============================================================================
train_ic:
  type: "mixed_comprehensive"

  gaussian:
    enabled: true
    positions_x: [2.0, 3.5, 5.0, 6.5, 8.0]
    positions_y: [2.5, 4.2, 5.8, 7.5]
    variances: [0.5, 1.0, 1.5, 2.0]
    n_samples_per_config: 1                    # 5×4×4 = 80 runs

  uniform:
    enabled: false
  ring:
    enabled: false
  two_clusters:
    enabled: false

# ============================================================================
# TEST: Gaussian-only, 25 runs (interpolated parameters)
# ============================================================================
test_ic:
  type: "mixed_comprehensive"

  gaussian:
    enabled: true
    test_positions_x: [2.8, 4.2, 5.8, 7.2, 9.0]
    test_positions_y: [3.3, 5.0, 6.7, 8.3, 1.5]
    test_variances: [1.25]                     # Interpolated variance
    n_samples_per_config: 1                    # 5×5×1 = 25 runs

  uniform:
    enabled: false
  ring:
    enabled: false
  two_clusters:
    enabled: false

# ============================================================================
# ROM CONFIGURATION
# ============================================================================
rom:
  subsample: 1
  pod_energy: 0.65         # ~8-10 modes → better ceiling (was 0.45 → 4 modes)

  models:
    mvar:
      enabled: true
      lag: 10               # 0.40s of history
      ridge_alpha: 1.0e-4   # Moderate ridge for ~10 modes

    lstm:
      enabled: true
      lag: 10               # Same as MVAR
      hidden_units: 128     # Bigger to capture cluster dynamics
      num_layers: 2
      max_epochs: 1500
      patience: 50          # Stop sooner if plateaued
      batch_size: 256
      learning_rate: 5.0e-4
      weight_decay: 1.0e-3
      gradient_clip: 1.0
      dropout: 0.1

# ============================================================================
# EVALUATION
# ============================================================================
eval:
  metrics: ["r2", "rmse"]
  save_forecasts: true
  forecast_start: 1.0      # Condition on first 1.0s (25 frames)
                            # Forecast remaining 9.0s → ~225 steps
