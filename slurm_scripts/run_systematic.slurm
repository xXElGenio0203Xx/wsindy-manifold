#!/bin/bash
#SBATCH --job-name=systematic
#SBATCH -N 1
#SBATCH -n 4
#SBATCH --mem=32G
#SBATCH --time=06:00:00
#SBATCH -p batch
#SBATCH --array=0-53
#SBATCH -o slurm_logs/systematic_%A_%a.out
#SBATCH -e slurm_logs/systematic_%A_%a.err

# ============================================================================
# SYSTEMATIC REGIME SWEEP — SLURM Array Job
# ============================================================================
# Runs all 54 configs (NDYN + d'Orsogna × {constant,variable} speed)
# Each array task picks one config from the manifest file.
#
# Usage:
#   sbatch slurm_scripts/run_systematic.slurm
#
# To run a subset:
#   sbatch --array=0-25 slurm_scripts/run_systematic.slurm   # first 26
#   sbatch --array=26-53 slurm_scripts/run_systematic.slurm  # last 28
# ============================================================================

module load python/3.11.11-5e66
source ~/wsindy_env_new/bin/activate

cd ~/wsindy-manifold
mkdir -p slurm_logs oscar_output

# The manifest lists one config path per line (generated by submit script)
MANIFEST="configs/systematic/manifest.txt"
if [ ! -f "$MANIFEST" ]; then
    echo "ERROR: $MANIFEST not found. Run shell_scripts/submit_systematic.sh first."
    exit 1
fi

# Pick the config for this array task
CONFIG=$(sed -n "$((SLURM_ARRAY_TASK_ID + 1))p" "$MANIFEST")
if [ -z "$CONFIG" ]; then
    echo "ERROR: No config for array index $SLURM_ARRAY_TASK_ID"
    exit 1
fi

# Derive experiment name from config filename (strip path + .yaml)
EXP_NAME=$(basename "$CONFIG" .yaml)

echo "============================================"
echo "SYSTEMATIC REGIME SWEEP"
echo "============================================"
echo "Array task:  $SLURM_ARRAY_TASK_ID / 53"
echo "Config:      $CONFIG"
echo "Experiment:  $EXP_NAME"
echo "Start time:  $(date)"
echo "Node:        $(hostname)"
echo "Python:      $(which python)"
echo ""

# Skip if already completed
if [ -f "oscar_output/$EXP_NAME/summary.json" ]; then
    echo "SKIP: $EXP_NAME already has summary.json — already completed."
    exit 0
fi

python ROM_pipeline.py \
    --config "$CONFIG" \
    --experiment_name "$EXP_NAME"

EXIT_CODE=$?
echo ""
echo "End time:  $(date)"
echo "Exit code: $EXIT_CODE"
exit $EXIT_CODE
